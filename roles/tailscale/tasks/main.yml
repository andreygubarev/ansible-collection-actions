---
- name: Tailscale | Prerequisites
  when: tailscale_install
  ansible.builtin.include_tasks: 000-prerequisite.yml

- name: Tailscale | Install
  when: tailscale_install
  ansible.builtin.include_tasks: 010-install.yml

- name: Tailscale configuration
  when: tailscale_enabled
  block:
    - name: Enable Tailscale service
      ansible.builtin.systemd:
        name: tailscaled
        state: started
        enabled: true

    - name: Wait for Tailscale to be ready
      ansible.builtin.wait_for:
        path: "{{ tailscale_socket }}"
        state: present
        timeout: 60

    - name: Register Tailscale status
      ansible.builtin.command: >-
        tailscale
        --socket {{ tailscale_socket }}
        status --json
      register: tailscale_status
      changed_when: false

    - name: Register Tailscale node
      when: (tailscale_status.stdout | from_json)['BackendState'] == 'NeedsLogin'
      block:
        - name: Assert Tailscale auth key is defined
          ansible.builtin.assert:
            that:
              - tailscale_authkey is defined
              - tailscale_authkey != ""
            success_msg: "Tailscale auth key is defined"
            fail_msg: "Tailscale auth key is not defined"

        - name: Register Tailscale node
          ansible.builtin.command: >-
            tailscale
            --socket {{ tailscale_socket }}
            up
            --hostname {{ ansible_hostname }}
            {% if tailscale_login_server %}
            --login-server {{ tailscale_login_server }}
            {% endif %}
            --timeout {{ tailscale_login_timeout }}
            --auth-key {{ tailscale_authkey }}
          changed_when: true

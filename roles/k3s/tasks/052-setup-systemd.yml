---
- name: Create systemd service environment
  ansible.builtin.template:
    src: k3s.service.env.j2
    dest: /etc/systemd/system/k3s.service.env
    owner: root
    group: root
    mode: 0644
  register: k3s_state_env

- name: Set node name
  when: k3s_node == ""
  ansible.builtin.set_fact:
    k3s_node: "{{ ansible_facts.hostname }}"

- name: Create systemd service
  ansible.builtin.template:
    src: k3s.service.j2
    dest: /etc/systemd/system/k3s.service
    owner: root
    group: root
    mode: 0644
  register: k3s_state_service

- name: Set systemd service state
  ansible.builtin.set_fact:
    k3s_state: "{{ 'restarted' if k3s_state_config.changed or k3s_state_service.changed or k3s_state_env.changed or k3s_binary.changed else 'started' }}"

- name: Ensure systemd service is running
  ansible.builtin.systemd:
    daemon_reload: "{{ k3s_state_service.changed or k3s_state_env.changed }}"
    name: k3s
    state: "{{ k3s_state }}"
    enabled: true
  register: result
  until: result is succeeded
  retries: 5
  delay: 10
